var WT=WT||{revision:0.1,file:{name:"untitled.wt",width:50,height:50,tilewidth:16,tileheight:16,tilesets:[],layers:[]},mesh:true};WT.clone=function(a){var b=function(){};b.prototype=a.prototype;return new b()};WT.pushTile=function(a){WT.file.tilesets.push(a)};WT.deleteTile=function(b){if(typeof b=="number"){return WT.file.tilesets.splice(b,1)}else{var c,a=WT.file.tilesets.length;for(var c=0;c<a;c++){if(WT.file.tilesets[c].name==b){return WT.file.tilesets.splice(c,1)}}}};WT.getTile=function(c){var b,a=WT.file.tilesets.length;for(var b=0;b<a;b++){if(WT.file.tilesets[b].id==c){return WT.file.tilesets[b]}}};WT.pushLayer=function(a){WT.file.layers.push(a)};WT.deleteLayer=function(c){var b,a=WT.file.layers.length;for(var b=0;b<a;b++){if(WT.file.layers[b].index==c){return WT.file.layers.splice(b,1)}}};WT.getLayer=function(c){var b,a=WT.file.layers.length;for(var b=0;b<a;b++){if(WT.file.layers[b].index==c){return WT.file.layers[b]}}};WT.getIndex=function(c){var b,a=WT.file.layers.length;for(var b=0;b<a;b++){if(WT.file.layers[b].index==c){return b}}};$(document).ready(function(){var q=WT.TileModule();var d=WT.StoreModule();var a=WT.MapModule(q.currentPiece,c);var e=WT.ToolbarModule(f,a.toggleState);function c(s){if(s.type===WT.RECT_LAYER){e.disable(true)}else{e.disable(false)}}var p;function h(u,t,s){p=u;$("#dialogHeader").html(t);$("#dialogBody").html(s);$("#dialogModal").modal("show")}function r(s){if(s){$("#tileHeader").html("重设图块");$("#tileName").val(s.name);$("#imageCtrl").hide();$("#tileWidth").val(s.tilewidth);$("#tileHeight").val(s.tileheight);$("#margin").val(s.margin);$("#spacing").val(s.spacing);p="tileAdjust"}else{$("#tileHeader").html("新图块");$("#tileName").val("");$("#imageCtrl").show();$("#tileImage").val("");$("#tileWidth").val(WT.file.tilewidth);$("#tileHeight").val(WT.file.tileheight);$("#margin").val("0");$("#spacing").val("0");p="tilePlus"}$("#tileModal").modal("show")}$('#toolTab a[data-toggle="tab"]').click(function(s){s.preventDefault();$(this).tab("show")});$("#file").click(function(s){switch(s.target.id){case"new":$("#fileModal").modal("show");break;case"export":g();break;case"save":b();break;case"saveAs":o();break}});$("#open").change(function(t){var s=t.target.files;if(s&&s.length>=1){d.restore(s[0],q,a)}});var m=document.getElementById("mapCanvasDiv");m.ondrop=function(t){var s=t.dataTransfer.files;if(s&&s.length>=1){d.restore(s[s.length-1],q,a);$("#view #toolbar").attr({disabled:false});e.toggle(true);e.select("stamp")}t.stopPropagation();t.preventDefault()};$("#tile").click(function(s){switch(s.target.id){case"addTile":r();break;case"delTile":n();break;case"adjTile":l();break}});$("#layer").click(function(s){switch(s.target.id){case"add":j();break;case"delete":i();break;case"rename":j(a.currentLayer());break;case"adjMap":k();break}});$("#view").click(function(s){switch(s.target.id){case"mesh":f();break;case"toolbar":e.toggle();break}});function f(){WT.mesh=!WT.mesh;$("#view #mesh").html(WT.mesh?"隐藏网格":"显示网格");var s=q.currentTileIndex();if(s!=-1){q.updateTileMeshCanvas(WT.file.tilesets[s])}if(a.isMapReady()){a.updateMapMeshCanvas()}}$("#tileCtrl").click(function(s){var t=s.target.id;switch(t){case"tilePlus":r();break;case"tileTrash":n();break;case"tileAdjust":l();break}});$("#layerCtrl").click(function(s){var t=s.target.id;switch(t){case"layerPlus":j();break;case"layerTrash":i();break;case"layerRevoke":if(!a.revoke()){h(null,"撤消动作","没有动作可供撤消！")}}});function k(){if(a.isMapReady()){$("#newWidth").val(WT.file.width);$("#newHeight").val(WT.file.height);$("#adjMapModal").modal("show")}else{h(null,"调整地图","请先新建或导入文件！")}}function n(){var t=q.currentTileIndex();if(t!=-1){var s=WT.file.tilesets[t];h("tileTrash","删除图块","确认删除当前图块【"+s.name+"】？")}else{h(null,"删除图块","请先选择某一图块！")}}function l(){var t=q.currentTileIndex();if(t!=-1){var s=WT.file.tilesets[t];r(s)}else{h(null,"重设图块","请先选择某一图块！")}}function j(s){if(s){if(a.isMapReady()){$("#lname").val(s.name);$("#layerType").hide();$("#layerModal").modal("show");p="layerRename"}else{h(null,"重命名图层","请先新建或导入文件！")}}else{if(a.isMapReady()){$("#lname").val("图层"+a.currentIndex());$("#layerType").show();$("#layerModal").modal("show");p="layerPlus"}else{h(null,"添加图层","请先新建或导入文件！")}}}function i(){if(a.isMapReady()){if(WT.file.layers.length>1){h("layerTrash","删除图块","确认删除当前图层【"+a.currentLayer().name+"】？")}else{h(null,"删除图层","请至少保留一个图层！")}}else{h(null,"删除图层","请先新建或导入文件！")}}function g(){if(a.isMapReady()){$("#filename").val(WT.file.name);$("#exportModal").modal("show")}else{h(null,"导出文件","请先新建或导入文件！")}}function o(){if(a.isMapReady()){$("#saveAsModal").modal("show")}else{h(null,"另存图片","请先新建或导入文件！")}}function b(){if(a.isMapReady()){$("#saveModal").modal("show")}else{h(null,"保存","请先新建或导入文件！")}}$("#dialogGroup").click(function(I){var D=q.currentTileIndex();switch(I.target.id){case"tileConfirm":switch(p){case"tilePlus":var L=$("#tileName").val(),F=$("#tileWidth").val()*1,y=$("#tileHeight").val()*1,z=$("#margin").val()*1,u=$("#spacing").val()*1;q.addTile(L,F,y,z,u);break;case"tileAdjust":var x=WT.file.tilesets[D];x.name=$("#tileName").val();x.tilewidth=$("#tileWidth").val()*1;x.tileheight=$("#tileHeight").val()*1;x.margin=$("#margin").val()*1;x.spacing=$("#spacing").val()*1;q.updateTileCanvas(x);break}$("#tileModal").modal("hide");p=null;break;case"dialogConfirm":switch(p){case"tileTrash":WT.deleteTile(D);var B=WT.file.tilesets.length<=0?-1:0;q.updateTileSelect(WT.file.tilesets,B);break;case"layerTrash":a.deleteCurrentLayer();break}$("#dialogModal").modal("hide");p=null;break;case"fileConfirm":WT.file.width=$("#fwidth").val()*1;WT.file.height=$("#fheight").val()*1;WT.file.tilewidth=$("#ftileWidth").val()*1;WT.file.tileheight=$("#ftileHeight").val()*1;a.updateMapCanvas();$("#fileModal").modal("hide");$("#view #toolbar").attr({disabled:false});e.toggle(true);e.select("stamp");break;case"layerConfirm":switch(p){case"layerPlus":var N=$("#lname").val();var s=$('input:radio[name="layerRadios"]:checked').val();a.createLayerCanvas(N,s);break;case"layerRename":var N=$("#lname").val();if(N!==""){var E=a.currentLayer();E.name=N;$("#ln"+E.index).html(N)}break}$("#layerModal").modal("hide");p=null;break;case"exportConfirm":var M=$("#filename").val();if(M!==""){WT.file.name=M}$("#exportModal").modal("hide");try{d.save()}catch(G){console.log(G);I.preventDefault()}break;case"saveConfirm":var t=$("#jsonName").val();if(t===""){t="unnamed"}var v=$("#hasTiles").attr("checked");var H=$("#hasLayers").attr("checked");$("#saveModal").modal("hide");d.exportJson(t,v,H);break;case"saveAsConfirm":var K=$("#imageName").val();if(K===""){K="unnamed"}$("#saveAsModal").modal("hide");d.exportImage(K);break;case"adjMapConfirm":var C=$("#newWidth").val()*1;var A=$("#newHeight").val()*1;var J=$("#rightOffset").val()*1;var w=$("#downOffset").val()*1;a.resize(C,A,J,w);$("#adjMapModal").modal("hide");break}})});WT.Color=function(a){if(a!==undefined){this.setHex(a)}};WT.Color.prototype={r:1,g:1,b:1,setHex:function(a){a=Math.floor(a);this.r=(a>>16&255)/255;this.g=(a>>8&255)/255;this.b=(a&255)/255;return this},setRGB:function(d,c,a){this.r=d;this.g=c;this.b=a;return this},setHSV:function(e,d,a){var c,j,k,g,b;if(a===0){this.r=this.g=this.b=0}else{c=Math.floor(e*6);j=(e*6)-c;k=a*(1-d);g=a*(1-(d*j));b=a*(1-(d*(1-j)));switch(c){case 1:this.r=g;this.g=a;this.b=k;break;case 2:this.r=k;this.g=a;this.b=b;break;case 3:this.r=k;this.g=g;this.b=a;break;case 4:this.r=b;this.g=k;this.b=a;break;case 5:this.r=a;this.g=k;this.b=g;break;case 6:case 0:this.r=a;this.g=b;this.b=k;break}}return this},toStyle:function(){return"rgb("+Math.floor(this.r*255)+","+Math.floor(this.g*255)+","+Math.floor(this.b*255)+")"},toRGBAStyle:function(a){return"rgba("+Math.floor(this.r*255)+","+Math.floor(this.g*255)+","+Math.floor(this.b*255)+","+a+")"}};WT.Rect=function(e,d,c,a,b){this.left=e!==undefined?e:0;this.top=d!==undefined?d:0;this.width=c!==undefined?c:0;this.height=a!==undefined?a:0;this.style=b!==undefined?b:"#ff0000"};WT.Rect.prototype={clone:function(){return new WT.Rect(this.left,this.top,this.width,this.height,this.style)}};WT.Tile=function(i,b,a,c,h,f,j,d,e,g){this._ctx=i;this.image=c!==undefined?c:null;this.id=b;this.name=a!==undefined?a:"unnamed";this.imagewidth=h!==undefined?h:0;this.imageheight=f!==undefined?c.height:0;this.tilewidth=j!==undefined?j:WT.file.tilewidth;this.tileheight=d!==undefined?d:WT.file.tileheight;this.margin=e!==undefined?e:0;this.spacing=g!==undefined?g:0;this._mesh=new WT.MeshTile();this._piece=null};WT.Tile.prototype={draw:function(a,b){this._ctx.drawImage(this.image,0,0,this.imagewidth,this.imageheight);if(this._piece!==null){this._piece.cover(this._ctx)}if(b){this._mesh.draw(a,this)}},onMouseDown:function(c){var d=this._mesh.onPiece(this,c.offsetX,c.offsetY);if(d){var a=this._ctx;if(this._piece===null){var b=a.getImageData(d.left,d.top,this.tilewidth,this.tileheight);this._piece=new WT.Piece(this.id,b,d.left,d.top);this._piece.cover(a)}else{if(d.left!==this._piece.left||d.top!==this._piece.top){var b=a.getImageData(d.left,d.top,this.tilewidth,this.tileheight);this._piece.restore(a);this._piece.reset(b,d.left,d.top);this._piece.cover(a)}}}},currentPiece:function(){return this._piece},clipImageData:function(e,d){var b=document.createElement("canvas");b.width=this.tilewidth;b.height=this.tileheight;var a=b.getContext("2d");a.drawImage(this.image,e,d,this.tilewidth,this.tileheight,0,0,this.tilewidth,this.tileheight);var c=a.getImageData(0,0,this.tilewidth,this.tileheight);b=null;return c}};WT.Piece=function(f,c,e,d,b,a){this.tileId=f;this.data=c;this.left=e;this.top=d;this.width=b!==undefined?b:(c?c.width:0);this.height=a!==undefined?a:(c?c.height:0)};WT.Piece.prototype={cover:function(a,b){a.putImageData(this.data,this.left,this.top,0,0,this.width,this.height);a.beginPath();a.rect(this.left,this.top,this.width,this.height);a.fillStyle=b||"rgba(255, 20, 147, 0.6)";a.fill()},restore:function(a){a.putImageData(this.data,this.left,this.top,0,0,this.width,this.height)},reset:function(c,e,d,b,a,f){this.data=c;this.left=e;this.top=d;this.width=b!==undefined?b:c.width;this.height=a!==undefined?a:c.height;if(f!==undefined){this.tileId=f}}};WT.Map=function(b,e,a,d,c){this.ctx=b;this.width=e!==undefined?e:WT.file.width;this.height=a!==undefined?a:WT.file.height;this.tilewidth=d!==undefined?d:WT.file.tilewidth;this.tileheight=c!==undefined?c:WT.file.tileheight;this.mesh=new WT.MeshMap();this.rect=new WT.Rect(null,null,this.tilewidth,this.tileheight)};WT.Map.prototype={draw:function(a){this.mesh.draw(this,a)},onMouseDown:function(c){var b=Math.floor(c.offsetX/this.tilewidth)*this.tilewidth;var a=Math.floor(c.offsetY/this.tileheight)*this.tileheight;this.rect.left=b;this.rect.top=a;return this.rect},onMouseMove:function(c){var b=Math.floor(c.offsetX/this.tilewidth)*this.tilewidth;var a=Math.floor(c.offsetY/this.tileheight)*this.tileheight;if(b!==this.rect.left||a!==this.rect.top){this.rect.left=b;this.rect.top=a;return this.rect}return null},resetRect:function(){this.rect.left=null;this.rect.top=null},resize:function(a,b){this.width=a;this.height=b}};WT.Layer=function(c,b,d,e,a,f){this._canvas=c!==undefined?c:null;this._ctx=this._canvas?this._canvas.getContext("2d"):null;this.index=a!==undefined?a:0;this.zIndex=f!==undefined?f:this.index;this.name=b!==undefined?b:"图层"+a;this.type=d!==undefined?d:WT.TILE_LAYER;this.visible=e!==undefined?e:true};WT.TILE_LAYER="tilelayer";WT.RECT_LAYER="rectlayer";WT.TileLayer=function(){WT.Layer.apply(this,arguments);this._piece=new WT.Piece();this.operations=[]};WT.TileLayer.prototype=WT.clone(WT.Layer);WT.TileLayer.prototype.cover=function(d,c){var a=this._ctx;var b=a.getImageData(d.left,d.top,c.width,c.height);this._piece.reset(b,d.left,d.top,c.width,c.height,c.tileId);a.putImageData(c.data,d.left,d.top,0,0,c.width,c.height)};WT.TileLayer.prototype.restore=function(){if(this._piece.left===undefined){return}var a=this._ctx;var b=this._piece;a.putImageData(b.data,b.left,b.top,0,0,b.width,b.height)};WT.TileLayer.prototype.record=function(c,b){var a=[b.tileId,b.left,b.top];a.push(c);this.operations.push(a)};WT.TileLayer.prototype.revoke=function(){if(this.operations.length>=1){var a=this.operations.pop();var d=WT.getTile(a[0]);var e=a[3];var c=e.length;for(var b=0;b<c;b+=2){this._ctx.clearRect(e[b],e[b+1],d.tilewidth,d.tileheight);(function(g,p){var f,h=this.operations.length;while(f=this.operations[--h]){var q=f[3];var m=q.length;var n,l;for(var k=0;k<m;k+=2){if(q[k]==g&&q[k+1]==p){n=n?n:WT.getTile(f[0]);l=l?l:n.clipImageData(f[1],f[2]);this._ctx.putImageData(l,g,p,0,0,n.tilewidth,n.tileheight)}}}}).call(this,e[b],e[b+1])}return true}return false};WT.TileLayer.prototype.restoreOperations=function(){var a=this._ctx;a.save();var b,c=-1;while(b=this.operations[++c]){var f=WT.getTile(b[0]);var g=f.clipImageData(b[1],b[2]);var h=b[3];var e=h.length;for(var d=0;d<e;d+=2){this._ctx.putImageData(g,h[d],h[d+1],0,0,f.tilewidth,f.tileheight)}}a.restore()};WT.TileLayer.prototype.resize=function(s,m,a,p){var e=a*WT.file.tilewidth,q=p*WT.file.tileheight;var u=e+this._canvas.width,b=q+this._canvas.height;var c,k=-1;while(c=this.operations[++k]){var x=c[3];var n=x.length;for(var g=0;g<n;g+=2){var f=x[g],v=x[g+1];if(f<e||f>=u||v<q||v>=b){x.splice(g,2);g-=2;n-=2}else{x[g]=f-e;x[g+1]=v-q}}if(x.length<=0){this.operations.splice(k,1);k--}}this.restoreOperations()};WT.RectLayer=function(){WT.Layer.apply(this,arguments);this.rects=[];this._start=null;this._rect=null};WT.RectLayer.prototype=(function(){var e=WT.clone(WT.Layer);e._color=new WT.Color();e._h=0;function d(h,g){g.save();g.beginPath();g.rect(h.left,h.top,h.width,h.height);g.fillStyle=h.style;g.fill();g.restore()}function a(h,g){g.save();h.forEach(function(j,i){g.beginPath();g.rect(j.left,j.top,j.width,j.height);g.fillStyle=j.style;g.fill()});g.restore()}function b(m,l){var i=new WT.Rect();var k,j,h,g;if(m.left<=l.left){k=m.left;h=l.left+l.width}else{k=l.left;h=m.left+m.width}if(m.top<=l.top){j=m.top;g=l.top+l.height}else{j=l.top;g=m.top+m.height}i.left=k;i.top=j;i.width=h-k;i.height=g-j;return i}e.begin=function(g){g.style=this._color.setHSV(this._h,0.8,0.8).toRGBAStyle(0.5);this._h+=0.1;if(this._h>1){this._h-=1}d(g,this._ctx);this._start=g;this._rect=g};e.move=function(g){if(this._start===null||g===null){return}this._canvas.width=this._canvas.width;a(this.rects,this._ctx);this._rect=b(this._start,g);this._rect.style=this._start.style;d(this._rect,this._ctx)};e.over=function(){if(this._start===null){return}this._canvas.width=this._canvas.width;this.rects.push(this._rect);a(this.rects,this._ctx);this._start=null};e.revoke=function(){if(this.rects.length>=1){this.rects.splice(this.rects.length-1,1);this._canvas.width=this._canvas.width;a(this.rects,this._ctx);if(this._start){d(this._rect,this._ctx)}return true}return false};e.restoreRects=function(){a(this.rects,this._ctx)};function f(i,j){var h=c({left:i.left,width:i.width},{left:j.left,width:j.width});if(h){var g=c({left:i.top,width:i.height},{left:j.top,width:j.height});if(g){i.left=h.left;i.width=h.width;i.top=g.left;i.height=g.width;return true}}return false}function c(g,i){var h;if(g.left<i.left){h=i.left-g.left;if(h>=g.width){return false}else{g.left=0;g.width=g.width-h}}else{g.left-=i.left;if(g.left>=i.width){return false}}if(g.left+g.width>i.width){g.width=i.width-g.left}return g}e.resize=function(g,l,n,p){var o=new WT.Rect(n*WT.file.tilewidth,p*WT.file.tileheight,this._canvas.width,this._canvas.height);var m,k=-1;var j=[];while(m=this.rects[++k]){if(!f(m,o)){this.rects.splice(k,1);k--}}this.restoreRects()};return e})();(function(){var a=window.CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype;if(a&&a.lineTo){a.dashedLine=function(n,k,b,l,h){if(!h){h=[10,2]}var g=h.length;this.moveTo(n,k);var p=(b-n),o=(l-k);var i=o/p;var e=Math.sqrt(p*p+o*o);var f=0,m=true;while(e>=0.1){var d=h[f++%g];if(d>e){d=e}if(p==0){var j=(l>k?1:-1);k+=d*j}else{var c=Math.sqrt(d*d/(1+i*i));var j=(b>n?1:-1);n+=c*j;k+=i*c*j}this[m?"lineTo":"moveTo"](n,k);e-=d;m=!m}},a.dashedRect=function(b,f,c,e,d){if(!d){d=[10,2]}this.beginPath();this.dashedLine(b,f,b+c,f,d);this.dashedLine(b,f,b,f+e,d);this.dashedLine(b+c,f,b+c,f+e,d);this.dashedLine(b,f+e,b+c,f+e,d);this.closePath();this.stroke()}}})();WT.MeshTile=function(){};WT.MeshTile.prototype={draw:function(m,f,e,a){var j=f.imagewidth-f.margin,c=f.imageheight-f.margin,d=f.tilewidth,b=f.tileheight;var k=m;k.save();k.lineWidth=e||1;k.beginPath();var l=1;var i=f.margin,g=f.margin;while(i<=j){k.moveTo(i,0);k.lineTo(i,f.imageheight);if(l){i+=d;l=0}else{i+=f.spacing;l=1}}l=1;while(g<=c){k.moveTo(0,g);k.lineTo(f.imagewidth,g);if(l){g+=b;l=0}else{g+=f.spacing;l=1}}k.strokeStyle=a||"#97ffff";k.stroke();k.restore()},onPiece:function(f,i,g){var e=f.tilewidth,a=f.tileheight,j=e+f.spacing,d=a+f.spacing;i=i-f.margin;g=g-f.margin;var c=i%j,b=g%d;if(c>0&&c<e&&b>0&&b<a){c=Math.floor(i/j),b=Math.floor(g/d);return{left:c*j,top:b*d}}return null}};WT.MeshMap=function(){};WT.MeshMap.prototype={draw:function(d,f){var o=d.tilewidth,m=d.tileheight,a=d.height,n=d.width;var k=o*n;var b=m*a;var e;var p=d.ctx;if(!f){return}p.save();p.beginPath();for(var l=0;l<=a;l++){e=l*m;p.dashedLine(0,e,k,e,[5,5])}for(var g=0;g<=n;g++){e=g*o;p.dashedLine(e,0,e,b,[5,5])}p.lineWidth=1;p.strokeStyle="#000";p.stroke();p.restore()}};WT.TileModule=function(){var m=-1;var l=0;var i=document.getElementById("tileCanvasDiv");var u=document.getElementById("tileCanvas"),o=u.getContext("2d");var p=document.getElementById("tileMeshCanvas"),r=p.getContext("2d");var j=$("#tileList");var q=$("#tileResult");function h(v,w){var x=[];v.forEach(function(z,y){x.push('<li><a href="#" id="');x.push(y);x.push('">');x.push(z.name);x.push("</a></li>")});j.html(x.join(""));$("#tileList li a").unbind("click");$("#tileList li a").click(function(y){m=y.target.id*1;a(v[y.target.id])});if(w!==undefined&&w>=0&&w<v.length){q.html(v[w].name);a(v[w]);m=w}else{q.html("&nbsp;");a(null);m=-1}}h(WT.file.tilesets);function a(v){if(null==v){u.width=250;u.height=250;p.width=250;p.height=250}else{u.width=v.imagewidth;u.height=v.imageheight;p.width=u.width;p.height=u.height;v.draw(r,WT.mesh);q.html(v.name);$('#tileList li a[id="'+m+'"]').html(v.name)}}function e(v){p.width=v.imagewidth;p.height=v.imageheight;v.draw(r,WT.mesh)}i.ondrop=function(z){var x=z.dataTransfer.files;var y,A=x.length;var v=-1;var w=x.length;while(y=x[++v]){if(y.type.indexOf("image")==0){(function(D){var C=D.name;var B=new FileReader();B.onload=function(F){var G=F.target.result;var E=new Image();E.onload=function(H){WT.pushTile(new WT.Tile(o,l++,C,this,this.width,this.height));if(--w==0){h(WT.file.tilesets,m==-1?0:m)}};E.src=G};B.readAsDataURL(D)})(y)}}z.stopPropagation();z.preventDefault()};var d=null;var k=$("#tileFile");function b(w){var v=w.target.files;if(v&&v.length>=1){d=v[0];$("#tileName").val(d.name);$("#tileImage").val(k.attr("value"))}}k.change(b);function s(x,y,w,z,A){if(!d){return}var v=new FileReader();v.onload=function(C){var D=C.target.result;var B=new Image();B.onload=function(E){WT.pushTile(new WT.Tile(o,l++,x,this,this.width,this.height,y,w,z,A));h(WT.file.tilesets,m==-1?0:m);d=null;k.attr({value:null})};B.src=D};v.readAsDataURL(d)}function f(v){if(m==-1){return}WT.file.tilesets[m].onMouseDown(v)}p.addEventListener("mousedown",f,false);function n(){return m}function t(){if(m==-1){return null}return WT.file.tilesets[m].currentPiece()}function c(){q.html("&nbsp;");j.empty();WT.file.tilesets=[];m=-1;l=0;a()}function g(v,A){var z,x=-1;var y=v.length;while(z=v[++x]){var w=new Image();w.onload=function(C){var B=this.tile;WT.pushTile(new WT.Tile(o,B.id,B.name,this,B.imagewidth,B.imageheight,B.tilewidth,B.tileheight,B.margin,B.spacing));if(--y==0){h(WT.file.tilesets,0);A()}};w.tile=z;w.src=z.image}l=v.length}return{currentTileIndex:n,updateTileSelect:h,updateTileCanvas:a,updateTileMeshCanvas:e,currentPiece:t,addTile:s,clearTiles:c,restoreTiles:g}};WT.MapModule=function(D,d){var o=$("#mapCanvasDiv");var j=$("#layerContainer");var l,z;var F,r;var g=0;var b,m;function B(){o.empty();j.empty();WT.file.layers=[];r=null;g=0;n();F=new WT.Map(z);F.draw(WT.mesh);b=new WT.ToolStamp("stamp",F,l,w,D);m=new WT.ToolRect("rect",F,l,w,D);A()}function f(){l.width=l.width;F.draw(WT.mesh)}function n(){l=document.createElement("canvas");z=l.getContext("2d");l.width=WT.file.width*WT.file.tilewidth;l.height=WT.file.height*WT.file.tileheight;l.id="meshCanvas";l.innerHTML="浏览器不支持Canvas:(";y();o.append(l)}function y(){if(l.width<mapCanvasDiv.clientWidth){l.style.left=(mapCanvasDiv.clientWidth-l.width)/2+"px"}else{l.style.left="0px"}if(l.height<mapCanvasDiv.clientHeight){l.style.top=(mapCanvasDiv.clientHeight-l.height)/2+"px"}else{l.style.top="0px"}l.style.zIndex="1000"}function A(I,K){var H=document.createElement("canvas");H.width=l.width;H.height=l.height;H.style.left=l.style.left;H.style.top=l.style.top;H.id="layerCanvas"+g;H.style.zIndex=g;o.append(H);var J;if(K===WT.RECT_LAYER){J=new WT.RectLayer(H,I,K,true,g,g)}else{J=new WT.TileLayer(H,I,K,true,g,g)}WT.pushLayer(J);c(J);e(J);g++}function c(J){var L=J.visible?" checked":"";var H=J.name;var K="未知";if(J.type===WT.TILE_LAYER){K="图块层"}else{if(J.type===WT.RECT_LAYER){K="框线层"}}var I=[];I.push('<td><input type="checkbox" id="lcb');I.push(J.index);I.push('"');I.push(L);I.push("></td>");I.push('<td id="ln');I.push(J.index);I.push('">');I.push(H);I.push("</td>");I.push('<td id="lt');I.push(J.index);I.push('">');I.push(K);I.push("</td>");I.push('<td><div class="btn-group">');I.push('<button class="btn-link"><i class="icon-arrow-up" id="lbup');I.push(J.index);I.push('"></i></a>');I.push('<button class="btn-link"><i class="icon-arrow-down" id="lbdown');I.push(J.index);I.push('"></i></a>');I.push("</div></td>");var M=document.createElement("tr");M.id="layer"+J.index;M.innerHTML=I.join("");j.append(M)}j.click(function(H){var J=H.target.id;var I=x(J,["lcb","ln","lbup","lbdown"]);if(I){switch(I.type){case"lcb":q(WT.getLayer(I.index));break;case"ln":e(WT.getLayer(I.index));break;case"lbup":s(I.index,true);break;case"lbdown":s(I.index,false);break}}});function x(L,K){for(var J=0,I=K.length;J<I;J++){var H=L.indexOf(K[J]);if(H==0){return{index:parseInt(L.slice(K[J].length)),type:K[J]}}}return null}function q(H){H.visible=!H.visible;if(H.visible){H._canvas.style.display="inline"}else{H._canvas.style.display="none"}}function e(I){if(!r){r=I;if(r.type===WT.RECT_LAYER){m.register()}else{b.register()}E(null,I.index);return}if(r.index!==I.index){var H=r;r=I;if(H.type===WT.RECT_LAYER&&r.type===WT.TILE_LAYER){m.unregister();b.register()}else{if(H.type===WT.TILE_LAYER&&r.type===WT.RECT_LAYER){b.unregister();m.register()}}E(H.index,I.index);v()}}function v(){if(r.type===WT.TILE_LAYER){switch(b.id){case"fill":b.mergeOperations();break}}}function E(I,H){if(I!==null){$("#layer"+I).css({backgroundColor:"transparent"})}$("#layer"+H).css({backgroundColor:"#add8e6"});d(r)}function s(I,J){var H=WT.getIndex(I);if(J){if(H===0){return false}i(H,H-1)}else{if(H===WT.file.layers.length-1){return false}i(H,H+1)}return true}function i(M,O){var N=WT.file.layers[M],L=WT.file.layers[O];var P=N.zIndex;N.zIndex=L.zIndex;L.zIndex=P;var K=$("#mapCanvasDiv #layerCanvas"+N.index);var I=$("#mapCanvasDiv #layerCanvas"+L.index);K.css({zIndex:N.zIndex});I.css({zIndex:L.zIndex});var J=$("#layer"+N.index);var H=$("#layer"+L.index);P=J.attr("id");J.attr({id:H.attr("id")});H.attr({id:P});P=J.css("backgroundColor");J.css({backgroundColor:H.css("backgroundColor")});H.css({backgroundColor:P});P=J.html();J.html(H.html());H.html(P);P=N;WT.file.layers[M]=L;WT.file.layers[O]=P;$("#lcb"+N.index).attr({checked:N.visible});$("#lcb"+L.index).attr({checked:L.visible})}function k(H){if(b&&b.id!==H){b.unregister();switch(H){case"stamp":b=new WT.ToolStamp("stamp",F,l,w,D);break;case"fill":b=new WT.ToolFill("fill",F,l,w,D);break;case"link":b=new WT.ToolLink("link",F,l,w,D);break}b.register()}}function G(){return F?true:false}function w(){return r}function h(){if(WT.file.layers.length>1){var H=r.index;WT.deleteLayer(H);$("#layer"+H).remove();$("#mapCanvasDiv #layerCanvas"+H).remove();if(r.type===WT.RECT_LAYER){m.unregister()}else{b.unregister()}r=null;e(WT.file.layers[0])}}function a(){return g}function p(){var H=r.revoke();v();return H}function u(){o.empty();j.empty();WT.file.layers=[];n();F=new WT.Map(z);F.draw(WT.mesh);b=new WT.ToolStamp("stamp",F,l,w,D);m=new WT.ToolRect("rect",F,l,w,D);r=null;g=0}function t(L){var J,I=-1;var K;while(J=L[++I]){var H=document.createElement("canvas");H.width=l.width;H.height=l.height;H.className="layer";H.style.left=l.style.left;H.style.top=l.style.top;H.id="layerCanvas"+J.index;H.style.zIndex=J.zIndex;H.style.display=J.visible?"inline":"none";o.append(H);if(J.type===WT.RECT_LAYER){K=new WT.RectLayer(H,J.name,J.type,J.visible,J.index,J.zIndex);K.rects=J.rects;K.restoreRects()}else{K=new WT.TileLayer(H,J.name,J.type,J.visible,J.index,J.zIndex);K.operations=J.operations;K.restoreOperations()}WT.pushLayer(K);c(K);if(J.index>g){g=J.index}}e(WT.file.layers[0]);g++}function C(H,K,L,M){WT.file.width=H;WT.file.height=K;l.width=H*WT.file.tilewidth;l.height=K*WT.file.tileheight;F.resize(H,K);F.draw(WT.mesh);y();var J,I=-1;while(J=WT.file.layers[++I]){J._canvas.width=l.width;J._canvas.height=l.height;J.resize(H,K,L,M);J._canvas.style.left=l.style.left;J._canvas.style.top=l.style.top}v()}return{updateMapCanvas:B,updateMapMeshCanvas:f,createLayerCanvas:A,isMapReady:G,currentLayer:w,deleteCurrentLayer:h,currentIndex:a,revoke:p,clearLayers:u,restoreLayers:t,resize:C,toggleState:k}};WT.StoreModule=function(){function e(){var h=JSON.stringify(WT.file,function(i,j){if(i.charAt(0)=="_"){return null}else{if(i=="image"){return j.src}else{return j}}},0);var g=new Blob([h]);window.URL=window.webkitURL||window.URL;$("#exportConfirm").attr({download:WT.file.name,href:window.URL.createObjectURL(g)})}function c(h,i,j){var g=new FileReader();g.onload=function(l){var k=JSON.parse(l.target.result);WT.file.name=k.name;WT.file.width=k.width;WT.file.height=k.height;WT.file.tilewidth=k.tilewidth;WT.file.tileheight=k.tileheight;i.clearTiles();j.clearLayers();if(k.tilesets.length>=1){i.restoreTiles(k.tilesets,function(){j.restoreLayers(k.layers)})}else{j.restoreLayers(k.layers)}};g.readAsText(h)}function b(l,v,q){var o={};if(v){var t=[];var s,p=-1;var h=WT.file.tilesets;while(s=h[++p]){t.push({id:s.id,name:s.name,tilewidth:s.tilewidth,tileheight:s.tileheight,imagewidth:s.imagewidth,imageheight:s.imageheight,imagesrc:s.image.src})}o.tiles=t}if(q){var n=[];var r,k=-1;var m=WT.file.layers;while(r=m[++k]){n.push(d(r))}o.layers=n;o.width=WT.file.width;o.height=WT.file.height;o.tilewidth=WT.file.tilewidth;o.tileheight=WT.file.tileheight}var u=JSON.stringify(o,null,0);var g=new Blob([u]);window.URL=window.webkitURL||window.URL;$("#saveConfirm").attr({download:l+".json",href:window.URL.createObjectURL(g)})}function d(s){var g={name:s.name,type:s.type};if(s.type===WT.TILE_LAYER){var w=[];var h=[];for(var q=0;q<WT.file.height;q++){h.push([])}var r,l=-1;while(r=s.operations[++l]){var u=f(w,r[0],r[1],r[2]);var z=r[3];var t=z.length;for(var j=0;j<t;j+=2){var o=Math.floor(z[j]/WT.file.tilewidth);var y=Math.floor(z[j+1]/WT.file.tileheight);h[y][o]=u}}g.tiles=w;g.map=h}else{var x=[];var v,p=-1;while(v=s.rects[++p]){x.push([v.left,v.top,v.width,v.height])}g.rects=x}return g}function f(j,m,g,h){var l,k=-1;while(l=j[++k]){if(l[0]==m&&l[1]==g&&l[2]==h){return k}}j.push([m,g,h]);return k}function a(t){var h=WT.file;var g=document.createElement("canvas");g.width=h.width*h.tilewidth;g.height=h.height*h.tileheight;var u=g.getContext("2d");var q,o=-1;while(q=h.layers[++o]){if(q.type==WT.TILE_LAYER&&q.visible){var p,m=-1;while(p=q.operations[++m]){var s=WT.getTile(p[0]);var n=s.clipImageData(p[1],p[2]);var v=p[3];var r=v.length;for(var l=0;l<r;l+=2){u.putImageData(n,v[l],v[l+1],0,0,s.tilewidth,s.tileheight)}}}}var n=g.toDataURL("image/png");$("#saveAsConfirm").attr({download:t+".png",href:n.replace("image/png","image/octet-stream")});g=null}return{save:e,restore:c,exportJson:b,exportImage:a}};WT.ToolbarModule=function(k,j){var a=$("#toolGroup");var c=true;var b=false;var h=1;var g=[{id:"move",tip:"移动"},{id:"stamp",tip:"印刻"},{id:"fill",tip:"填充"},{id:"link",tip:"连接"},{id:"grid",tip:"网格"},{id:"direction",tip:"方向"}];var o=[];var n=true;function p(q){n=q;a.empty();o=[];var r,t=-1;while(r=g[++t]){var s=document.createElement("button");s.id=r.id;s.title=r.tip;s.style.backgroundImage='url("./img/'+r.id+'.png")';a.append(s);if(q){a.append("<br/>")}o.push(s)}o[0].style.cursor="move";o[h].style.backgroundColor="skyBlue"}(function(){p(true);a.css({left:120,top:140});f(false)})();a.mousedown(function(q){var r=q.target.id;switch(r){case"move":a.toggleClass("on");a.toggleClass("off");document.addEventListener("mousemove",m,false);document.addEventListener("mouseup",i,false);break;case"grid":k();break;case"direction":p(!n);break;default:l(r);break}});function e(s){var r=-1,q;while(q=g[++r]){if(q.id===s){return r}}}function m(s){var r=s.clientX-10,q=s.clientY-10;if(r<0){r=0}else{if(r>window.innerWidth-a.width()-2){r=window.innerWidth-a.width()-2}}if(q<0){q=0}else{if(q>window.innerHeight-a.height()-2){q=window.innerHeight-a.height()-2}}window.innerWidth,window.innerHeight;a.css({left:r,top:q});s.stopPropagation();s.preventDefault()}function i(q){a.toggleClass("on");a.toggleClass("off");document.removeEventListener("mousemove",m,false);document.removeEventListener("mouseup",i,false)}function l(q){if(b){return}o[h].style.backgroundColor="white";h=e(q);o[h].style.backgroundColor="skyBlue";j(q)}function f(q){c=q!==undefined?q:!c;a.toggle(c);$("#view #toolbar").html(c?"隐藏工具栏":"显示工具栏")}function d(s){b=s;var q=1;var r=b?"gray":"white";for(;q<=3;q++){o[q].disabled=b;o[q].style.backgroundColor=r}if(!b){o[h].style.backgroundColor="skyBlue"}}return{select:l,toggle:f,disable:d}};WT.ToolBase=function(e,d,c,a,b){this.id=e;this.map=d;this.meshCanvas=c;this.currentLayer=a;this.currentPiece=b};WT.ToolBase.prototype={reset:function(b,a){this.map=b;this.meshCanvas=a},register:function(){this.come();var b=this.getEvents();var c,a=-1;while(c=b[++a]){this.meshCanvas.addEventListener(c.type,c.listener,false)}},unregister:function(){this.leave();var b=this.getEvents();var c,a=-1;while(c=b[++a]){this.meshCanvas.removeEventListener(c.type,c.listener,false)}},come:function(){},leave:function(){},getEvents:function(){return[]}};WT.ToolRect=function(c,b,a){if(typeof WT.ToolRect.instance==="object"){WT.ToolRect.instance.reset(b,a);return WT.ToolRect.instance}WT.ToolBase.apply(this,arguments);WT.ToolRect.instance=this};WT.ToolRect.prototype=(function(){var b,g;var f,a;var d=false;function i(j){var k=b.onMouseDown(j);if(k){f().begin(k.clone())}d=true;g.addEventListener("mouseup",e,false);g.addEventListener("mouseout",e,false)}function c(k){if(d){var j=b.onMouseMove(k);if(j){f().move(j)}}k.preventDefault()}function e(j){g.removeEventListener("mouseup",e,false);g.removeEventListener("mouseout",e,false);f().over();d=false}var h=WT.clone(WT.ToolBase);h.come=function(){b=this.map;g=this.meshCanvas;f=this.currentLayer;a=this.currentPiece};h.leave=function(){};h.getEvents=function(){return[{type:"mousedown",listener:i},{type:"mousemove",listener:c}]};return h})();WT.ToolStamp=function(c,b,a){if(typeof WT.ToolStamp.instance==="object"){WT.ToolStamp.instance.reset(b,a);return WT.ToolStamp.instance}WT.ToolBase.apply(this,arguments);WT.ToolStamp.instance=this};WT.ToolStamp.prototype=(function(){var b,h;var g,a;var d=false;var l=false;function k(o){var n=b.onMouseDown(o);var m=a();if(n&&m){e.push(n.left,n.top);g().cover(n,m)}l=false;d=true;h.addEventListener("mouseup",f,false)}var e=[];function c(p){var o=b.onMouseMove(p);var n=a();if(o&&n){var m=g();if(d){e.push(o.left,o.top)}else{if(l){l=false}else{m.restore()}}m.cover(o,n)}p.preventDefault()}function f(n){if(d){var m=a();if(m){g().record(e,m);e=[]}}else{g().restore();b.resetRect()}l=true;d=false;h.removeEventListener("mouseup",f,false)}function i(m){f(m)}var j=WT.clone(WT.ToolBase);j.come=function(){b=this.map;h=this.meshCanvas;g=this.currentLayer;a=this.currentPiece};j.leave=function(){};j.getEvents=function(){return[{type:"mousedown",listener:k},{type:"mousemove",listener:c},{type:"mouseout",listener:i}]};return j})();WT.ToolFill=function(c,b,a){if(typeof WT.ToolFill.instance==="object"){WT.ToolFill.instance.reset(b,a);return WT.ToolFill.instance}WT.ToolBase.apply(this,arguments);WT.ToolFill.instance=this};WT.ToolFill.prototype=(function(){var u,k;var p,t;var f,e;function b(){f=[];e=[];for(var B=0;B<u.height;B++){e.push([])}var D=p();var w=D.operations;var C,y=-1;while(C=w[++y]){var A=j(C[0],C[1],C[2]);var G=C[3];var E=G.length;for(var x=0;x<E;x+=2){var z=Math.floor(G[x]/u.tilewidth);var F=Math.floor(G[x+1]/u.tileheight);e[F][z]=A}}a=null}function j(A,w,x){var z,y=-1;while(z=f[++y]){if(z[0]==A&&z[1]==w&&z[2]==x){return y}}f.push([A,w,x]);return y}function n(C,A){var x=[];var B=e.length;for(var z=0;z<B;z++){x.push(e[z].slice(0))}var w=[];var y=x[C][A];q(w,y,x,C,A);return{coords:w,resultMap:x}}function q(x,y,w,B,z){var A=w[B][z];if(A!=y){return}x.push([B,z]);w[B][z]=-1;if(B-1>=0){q(x,y,w,B-1,z)}if(B+1<u.height){q(x,y,w,B+1,z)}if(z-1>=0){q(x,y,w,B,z-1)}if(z+1<u.width){q(x,y,w,B,z+1)}}var g=false;var v=false;var o,a;var h,c;function i(z){var y=t();if(!y){return}var A=j(y.tileId,y.left,y.top);var w=[];var B,x=-1;while(B=a.coords[++x]){e[B[0]][B[1]]=A;w.push(B[1]*u.tilewidth,B[0]*u.tileheight)}p().record(w,y);g=true}function m(z){var y=u.onMouseMove(z);var x=t();if(y&&x){var w=Math.floor(y.left/u.tilewidth),A=Math.floor(y.top/u.tileheight);if(a&&a.resultMap[A][w]==-1){if(v){s();v=false}return}if(g){g=false}else{r()}o=e[A][w];a=n(A,w);s()}}function l(w){if(!g){r();u.resetRect();v=true}}function s(){var w=p()._ctx,y=t();var B,x=-1;while(B=a.coords[++x]){var A=B[1]*u.tilewidth,z=B[0]*u.tileheight;w.putImageData(y.data,A,z,0,0,y.width,y.height)}}function r(){if(!a){return}var w=p()._ctx;if(o===undefined){var C,x=-1;while(C=a.coords[++x]){var B=C[1]*u.tilewidth,A=C[0]*u.tileheight;w.clearRect(B,A,u.tilewidth,u.tileheight)}return}var y=WT.getTile(f[o][0]);var z=y.clipImageData(f[o][1],f[o][2]);var C,x=-1;while(C=a.coords[++x]){var B=C[1]*u.tilewidth,A=C[0]*u.tileheight;w.putImageData(z,B,A,0,0,y.tilewidth,y.tileheight)}}var d=WT.clone(WT.ToolBase);d.come=function(){u=this.map;k=this.meshCanvas;p=this.currentLayer;t=this.currentPiece;b()};d.leave=function(){};d.getEvents=function(){return[{type:"mousedown",listener:i},{type:"mousemove",listener:m},{type:"mouseout",listener:l}]};d.mergeOperations=b;return d})();WT.ToolLink=function(c,b,a){if(typeof WT.ToolLink.instance==="object"){WT.ToolLink.instance.reset(b,a);return WT.ToolLink.instance}WT.ToolBase.apply(this,arguments);WT.ToolLink.instance=this};WT.ToolLink.prototype=(function(){var u,l;var o,t;function v(x,E,w,D){var B=[];var z,F,y;var A=Math.abs(x-w),C=Math.abs(E-D);if(A>C){z=x>w?-1:1;F=x+z;for(;Math.abs(x-F)<A;F+=z){y=E+(D-E)*(F-x)/(w-x);B.push([F,Math.round(y)])}}else{z=E>D?-1:1;y=E+z;for(;Math.abs(E-y)<C;y+=z){F=x+(w-x)*(y-E)/(D-E);B.push([Math.round(F),y])}}return B}var r,a;var g,d;var i,e;var h=false;var k=false;function j(A){if(!t()){return}var x=Math.floor(A.offsetX/u.tilewidth),D=Math.floor(A.offsetY/u.tileheight);if(!k){a=[[D,x]];var w=x*u.tilewidth,B=D*u.tileheight;var C=o()._ctx,E=t();C.putImageData(E.data,w,B,0,0,E.width,E.height);i=D,i=x;g=D,d=x;k=true;h=true;return}var z,y=-1;while(z=r[++y]){a.push(z)}if(c(D,x)){a.pop();b();k=false;h=false}else{i=D,i=x;g=D,d=x;h=true}}function c(z,y){var A,w=a.length-2;for(var x=0;x<=w;x++){A=a[x];if(A[0]===z&&A[1]===y){return true}}return false}function n(x){if(!k||!t()){return}var w=Math.floor(x.offsetX/u.tilewidth),y=Math.floor(x.offsetY/u.tileheight);if(y==i&&w==e){return}i=y,e=w;if(h){h=false}else{p()}r=v(g,d,y,w);r.push([y,w]);q()}function m(w){if(!k||!t()){return}p();r=[];k=false;b()}var s=[];function q(){s=[];var w=o()._ctx,y=t();var B,x=-1;while(B=r[++x]){var A=B[1]*u.tilewidth,z=B[0]*u.tileheight;s.push(w.getImageData(A,z,y.width,y.height));w.putImageData(y.data,A,z,0,0,y.width,y.height)}}function p(){var w=o()._ctx;var A,x=-1;while(A=r[++x]){var z=A[1]*u.tilewidth,y=A[0]*u.tileheight;w.putImageData(s[x],z,y,0,0,u.tilewidth,u.tileheight)}}function b(){var w=[];var y,x=-1;while(y=a[++x]){w.push(y[1]*u.tilewidth,y[0]*u.tileheight)}o().record(w,t())}var f=WT.clone(WT.ToolBase);f.come=function(){u=this.map;l=this.meshCanvas;o=this.currentLayer;t=this.currentPiece};f.leave=function(){};f.getEvents=function(){return[{type:"mousedown",listener:j},{type:"mousemove",listener:n},{type:"mouseout",listener:m}]};return f})();